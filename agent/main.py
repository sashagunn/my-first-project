#!/usr/bin/env python3
"""
Prodigy Lab â€” Content Agent
ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ¸Ğ»ÑÑ‹, ÑĞ»ĞµĞ´Ğ¸Ñ‚ Ğ·Ğ° ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸,
Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ»Ğ°Ğ½ Ğ¸ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ½ĞµĞ´ĞµĞ»Ñ.
"""

import json
import os
import sys
from datetime import datetime
from pathlib import Path

from dotenv import load_dotenv
import anthropic
import requests

load_dotenv()

# â”€â”€ ĞŸÑƒÑ‚Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR   = Path(__file__).parent
DATA_FILE  = BASE_DIR / "data" / "reels.json"
PLANS_DIR  = BASE_DIR / "plans"

# â”€â”€ ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_api_key = os.getenv("ANTHROPIC_API_KEY")
if not _api_key:
    print("âŒ ANTHROPIC_API_KEY Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² .env")
    sys.exit(1)

claude = anthropic.Anthropic(api_key=_api_key)

TG_TOKEN   = os.getenv("TELEGRAM_BOT_TOKEN", "")
TG_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID", "")

# â”€â”€ ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ±Ñ€ĞµĞ½Ğ´Ğ° (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²Ğ¾ Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°Ñ…) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BRAND = """
ĞĞºĞºĞ°ÑƒĞ½Ñ‚: @prodigylab.agency
ĞĞ¸ÑˆĞ°: Shopify-ÑÑ‚ÑƒĞ´Ğ¸Ñ â€” Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¾Ğ² Ğ·Ğ° 14 Ğ´Ğ½ĞµĞ¹
ĞÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ: Ğ ÑƒÑÑĞºĞ¾ÑĞ·Ñ‹Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ² Ğ¡Ğ¨Ğ / Ğ•Ğ²Ñ€Ğ¾Ğ¿Ğµ / Ğ¡ĞĞ“
ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ğº Ğ¿Ğ¾ e-commerce Ğ¸Ğ· Ğ¡Ğ¨Ğ â€” Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸, Ğ·Ğ½Ğ°ĞµÑ‚ Ñ€Ñ‹Ğ½Ğ¾Ğº Ğ¸Ğ·Ğ½ÑƒÑ‚Ñ€Ğ¸
Ğ¢Ğ¾Ğ½: ĞŸÑ€ÑĞ¼Ğ¾Ğ¹, Ğ±ĞµĞ· Ğ²Ğ¾Ğ´Ñ‹, ĞºĞ°Ğº Ñ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼-Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ‚ĞµĞ»ĞµĞ¼. ĞĞ¸ĞºĞ°ĞºĞ¾Ğ³Ğ¾ Ğ¸Ğ½Ñ„Ğ¾Ğ±Ğ¸Ğ·Ğ½ĞµÑĞ°.

8 Ğ¤ĞĞ ĞœĞĞ¢ĞĞ’:
Ğ â€” Ğ‘Ğ¾Ğ»ÑŒ        15-30 ÑĞµĞº  Ğ¥ÑƒĞºâ†’Ğ‘Ğ¾Ğ»ÑŒâ†’Ğ£ÑĞ¸Ğ»ĞµĞ½Ğ¸Ğµâ†’ĞĞ°Ğ¼Ñ‘Ğº Ğ½Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµâ†’CTA
Ğ‘ â€” ĞĞ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ  30-60 ÑĞµĞº  Ğ¥ÑƒĞº Ñ Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ¹â†’Ğ¢ĞµĞ·Ğ¸Ñâ†’3 Ğ¿ÑƒĞ½ĞºÑ‚Ğ°â†’"Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸"
Ğ’ â€” Ğ—Ğ° ĞºÑƒĞ»Ğ¸ÑĞ°Ğ¼Ğ¸  15-45 ÑĞµĞº  Ğ¥ÑƒĞºâ†’ĞŸÑ€Ğ¾Ñ†ĞµÑÑ (ÑĞºÑ€Ğ°Ğ½/Ñ€ÑƒĞºĞ¸)â†’CTA
Ğ“ â€” ĞšĞµĞ¹Ñ        30-60 ÑĞµĞº  Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚â†’Ğ‘Ñ‹Ğ»Ğ¾/ÑÑ‚Ğ°Ğ»Ğ¾â†’Ğ§Ñ‚Ğ¾ ÑĞ´ĞµĞ»Ğ°Ğ»Ğ¸â†’CTA
Ğ” â€” Ğ®Ğ¼Ğ¾Ñ€        15-25 ÑĞµĞº  Setupâ†’Ğ ĞµĞ°ĞºÑ†Ğ¸Ñâ†’Ğ¢Ğ²Ğ¸ÑÑ‚â†’Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹ CTA
Ğ• â€” ĞŸÑ€Ğ¾Ğ²Ğ¾ĞºĞ°Ñ†Ğ¸Ñ   30-35 ÑĞµĞº  Ğ¡Ğ¿Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ·Ğ¸Ñâ†’Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°â†’ĞĞ³Ğ¾Ğ²Ğ¾Ñ€ĞºĞ°â†’Ğ”Ğ¸ÑĞºÑƒÑÑĞ¸Ñ
Ğ– â€” POV         15-30 ÑĞµĞº  "POV:"â†’Ğ¡Ñ†ĞµĞ½Ğ°â†’ĞœĞ¾Ñ€Ğ°Ğ»ÑŒ
Ğ— â€” Ğ Ğ°Ğ·Ğ±Ğ¾Ñ€       45-60 ÑĞµĞº  Ğ¥ÑƒĞº Ñ Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ¹â†’Screen Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€â†’CTA Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ°

ĞŸĞ ĞĞŸĞĞ Ğ¦Ğ˜Ğ˜ (Ğ¤Ğ°Ğ·Ğ° 1, Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 6 Ğ½ĞµĞ´ĞµĞ»ÑŒ):
50% â€” Ğ+Ğ”+Ğ–  (Ğ¾Ñ…Ğ²Ğ°Ñ‚, Ñ€ĞµĞ¿Ğ¾ÑÑ‚Ñ‹)
25% â€” Ğ•       (ÑĞ¿Ğ¾Ñ€Ñ‹ â†’ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼)
15% â€” Ğ‘+Ğ—     (ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ, Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ)
10% â€” Ğ’       (Ñ‡ĞµĞ»Ğ¾Ğ²ĞµÑ‡Ğ½Ğ¾ÑÑ‚ÑŒ)

Ğ Ğ˜Ğ¢Ğœ: 4-5 Reels Ğ² Ğ½ĞµĞ´ĞµĞ»Ñ. ĞŸĞ½: Ğ”/Ğ–, Ğ¡Ñ€: Ğ, ĞŸÑ‚: Ğ•/Ğ‘, Ğ’Ñ: Ğ’
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DATA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def load_data() -> dict:
    if not DATA_FILE.exists():
        DATA_FILE.parent.mkdir(parents=True, exist_ok=True)
        empty = {"reels": [], "last_updated": None}
        _write_json(DATA_FILE, empty)
        return empty
    with open(DATA_FILE, encoding="utf-8") as f:
        return json.load(f)


def save_data(data: dict):
    data["last_updated"] = datetime.now().isoformat()
    _write_json(DATA_FILE, data)


def _write_json(path: Path, obj: dict):
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        json.dump(obj, f, ensure_ascii=False, indent=2)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INPUT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FORMAT_NAMES = {
    "Ğ": "Ğ‘Ğ¾Ğ»ÑŒ", "Ğ‘": "ĞĞ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ", "Ğ’": "Ğ—Ğ° ĞºÑƒĞ»Ğ¸ÑĞ°Ğ¼Ğ¸",
    "Ğ“": "ĞšĞµĞ¹Ñ", "Ğ”": "Ğ®Ğ¼Ğ¾Ñ€", "Ğ•": "ĞŸÑ€Ğ¾Ğ²Ğ¾ĞºĞ°Ñ†Ğ¸Ñ", "Ğ–": "POV", "Ğ—": "Ğ Ğ°Ğ·Ğ±Ğ¾Ñ€"
}


def _ask(prompt: str, default: str = "") -> str:
    val = input(f"{prompt}: ").strip()
    return val if val else default


def _ask_int(prompt: str) -> int:
    val = input(f"{prompt}: ").strip()
    return int(val) if val.isdigit() else 0


def input_reels(data: dict):
    """Ğ’Ğ²Ğ¾Ğ´ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ€Ğ¸Ğ»ÑĞ¾Ğ²."""
    _header("ğŸ“Š ĞœĞ•Ğ¢Ğ Ğ˜ĞšĞ˜ ĞĞŸĞ£Ğ‘Ğ›Ğ˜ĞšĞĞ’ĞĞĞĞ«Ğ¥ Ğ Ğ˜Ğ›Ğ¡ĞĞ’")
    print("Ğ’Ğ²Ğ¾Ğ´Ğ¸ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ. ĞŸÑƒÑÑ‚Ğ¾Ğ¹ Enter ĞºĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸ÑˆÑŒ.\n")

    while True:
        cont = input("Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ğ¸Ğ»Ñ? [Enter=Ğ´Ğ° / n=Ğ½ĞµÑ‚] > ").strip().lower()
        if cont == "n":
            break

        reel = {}
        reel["id"]       = f"reel_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        reel["date"]     = _ask("Ğ”Ğ°Ñ‚Ğ° (Ğ“Ğ“Ğ“Ğ“-ĞœĞœ-Ğ”Ğ”)", datetime.now().strftime("%Y-%m-%d"))

        print(f"Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹: {', '.join(f'{k}={v}' for k,v in FORMAT_NAMES.items())}")
        fmt = _ask("Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚", "Ğ").upper()
        reel["format"]      = fmt if fmt in FORMAT_NAMES else "Ğ"
        reel["format_name"] = FORMAT_NAMES[reel["format"]]
        reel["hook"]        = _ask("Ğ¥ÑƒĞº (Ñ‚ĞµĞºÑÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ´Ñ€Ğ°)")
        reel["notes"]       = _ask("Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ (Ñ‡Ñ‚Ğ¾ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¸Ğ», Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ñ)")

        print("ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Enter = 0):")
        reel["metrics"] = {
            "views":    _ask_int("  ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ñ‹"),
            "likes":    _ask_int("  Ğ›Ğ°Ğ¹ĞºĞ¸"),
            "comments": _ask_int("  ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸"),
            "saves":    _ask_int("  Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ"),
            "shares":   _ask_int("  Ğ ĞµĞ¿Ğ¾ÑÑ‚Ñ‹"),
            "reach":    _ask_int("  ĞÑ…Ğ²Ğ°Ñ‚ (ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ…)"),
            "days_live":_ask_int("  Ğ”Ğ½ĞµĞ¹ Ğ² ÑÑ„Ğ¸Ñ€Ğµ"),
        }

        data["reels"].append(reel)
        save_data(data)
        print(f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½: Â«{reel['hook'][:60]}Â»\n")


def input_competitors() -> list:
    """Ğ’Ğ²Ğ¾Ğ´ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ¾Ğ² ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ·Ğ°Ğ»ĞµÑ‚ĞµĞ»Ğ¸."""
    _header("ğŸ” ĞŸĞĞ¡Ğ¢Ğ« ĞšĞĞĞšĞ£Ğ Ğ•ĞĞ¢ĞĞ’")
    print("Ğ¡ĞºĞ¸Ğ´Ñ‹Ğ²Ğ°Ğ¹ Ğ¿Ğ¾ÑÑ‚Ñ‹ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ»Ğ¸ÑÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ»ĞµÑ‚ĞµĞ»Ğ¸.\n")

    posts = []
    while True:
        cont = input("Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚? [Enter=Ğ´Ğ° / n=Ğ½ĞµÑ‚] > ").strip().lower()
        if cont == "n":
            break

        post = {
            "date":         datetime.now().strftime("%Y-%m-%d"),
            "account":      _ask("ĞĞºĞºĞ°ÑƒĞ½Ñ‚ (@username)"),
            "url":          _ask("Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚"),
            "hook":         _ask("Ğ¥ÑƒĞº / Ñ‚ĞµĞ¼Ğ° Ğ¿Ğ¾ÑÑ‚Ğ°"),
            "views":        _ask("ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ñ‹ (ĞµÑĞ»Ğ¸ Ğ²Ğ¸Ğ´Ğ½Ğ¾)"),
            "format_guess": _ask("Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (Ğ-Ğ— Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ)"),
            "why_works":    _ask("ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¾ (Ñ‚Ğ²Ğ¾Ñ‘ Ğ¼Ğ½ĞµĞ½Ğ¸Ğµ)"),
        }
        posts.append(post)
        print(f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½: {post['account']}\n")

    return posts


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CLAUDE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def _ask_claude(prompt: str, max_tokens: int = 2000) -> str:
    msg = claude.messages.create(
        model="claude-sonnet-4-5-20250929",
        max_tokens=max_tokens,
        messages=[{"role": "user", "content": prompt}]
    )
    return msg.content[0].text


def analyze(data: dict, competitors: list) -> str:
    """ĞĞ½Ğ°Ğ»Ğ¸Ğ· ÑĞ²Ğ¾Ğ¸Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº + ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ¾Ğ²."""
    print("\nğŸ¤– ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ...")

    reels = sorted(data.get("reels", []), key=lambda x: x.get("date", ""), reverse=True)[:20]

    reels_txt = "\n".join(
        f"[{r['date']}] Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ {r['format']} Â«{r['hook']}Â» | "
        f"Views:{r['metrics'].get('views',0)} Likes:{r['metrics'].get('likes',0)} "
        f"Saves:{r['metrics'].get('saves',0)} Shares:{r['metrics'].get('shares',0)} "
        f"Comments:{r['metrics'].get('comments',0)} | Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸: {r.get('notes','â€”')}"
        for r in reels
    ) or "Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ â€” Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº."

    comp_txt = "\n".join(
        f"{c['account']}: Â«{c['hook']}Â» | Views: {c.get('views','Ğ½/Ğ´')} | "
        f"Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: {c.get('format_guess','?')} | ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚: {c.get('why_works','?')}"
        for c in competitors
    ) or "Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ°Ğ¼ Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾."

    return _ask_claude(f"""
Ğ¢Ñ‹ â€” ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³ Instagram-Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ¾ Shopify Ğ¸ e-commerce.

ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ Ğ‘Ğ Ğ•ĞĞ”Ğ:
{BRAND}

ĞĞŸĞ£Ğ‘Ğ›Ğ˜ĞšĞĞ’ĞĞĞĞ«Ğ• Ğ Ğ˜Ğ›Ğ¡Ğ« (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 20):
{reels_txt}

ĞŸĞĞ¡Ğ¢Ğ« ĞšĞĞĞšĞ£Ğ Ğ•ĞĞ¢ĞĞ’ (Ñ‡Ñ‚Ğ¾ Ğ·Ğ°Ğ»ĞµÑ‚ĞµĞ»Ğ¾ Ñƒ Ğ½Ğ¸Ñ…):
{comp_txt}

Ğ¡Ğ´ĞµĞ»Ğ°Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ¾ 4 Ğ¿ÑƒĞ½ĞºÑ‚Ğ°Ğ¼:
1. Ğ¢ĞĞŸ-3 Ğ»ÑƒÑ‡ÑˆĞ¸Ñ… ÑĞ²Ğ¾Ğ¸Ñ… Ñ€Ğ¸Ğ»ÑĞ° â€” Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚, ĞºĞ°ĞºĞ¾Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½
2. Ğ§Ñ‚Ğ¾ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ â€” Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹/Ñ…ÑƒĞºĞ¸ Ñ Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¼Ğ¸ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ°Ğ¼Ğ¸, Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ
3. Ğ˜Ğ½ÑĞ°Ğ¹Ñ‚Ñ‹ Ğ¾Ñ‚ ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ¾Ğ² â€” Ñ‡Ñ‚Ğ¾ Ğ²Ğ·ÑÑ‚ÑŒ, Ñ‡Ñ‚Ğ¾ ĞĞ• ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
4. Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ â€” Ğ¾Ğ´Ğ½Ğ° Ñ„Ñ€Ğ°Ğ·Ğ° Ñ‡Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒÑĞ¸Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ

ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾, Ğ±ĞµĞ· Ğ²Ğ¾Ğ´Ñ‹, Ğ¿Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼.
""", max_tokens=1500)


def generate_plan(analysis: str, data: dict) -> str:
    """ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ½ĞµĞ´ĞµĞ»Ñ."""
    print("ğŸ“… Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ...")

    recent_formats = [r.get("format", "Ğ") for r in data.get("reels", [])[-8:]]
    formats_used = ", ".join(recent_formats) or "Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"

    return _ask_claude(f"""
Ğ¢Ñ‹ â€” ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³ @prodigylab.agency.

ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ Ğ‘Ğ Ğ•ĞĞ”Ğ:
{BRAND}

ĞĞĞĞ›Ğ˜Ğ— ĞŸĞ ĞĞ¨Ğ›ĞĞ™ ĞĞ•Ğ”Ğ•Ğ›Ğ˜:
{analysis}

Ğ¤ĞĞ ĞœĞĞ¢Ğ« ĞŸĞĞ¡Ğ›Ğ•Ğ”ĞĞ˜Ğ¥ 8 ĞŸĞĞ¡Ğ¢ĞĞ’: {formats_used}

Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ½ĞµĞ´ĞµĞ»Ñ â€” 4 Ğ¿Ğ¾ÑÑ‚Ğ°.

Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ°:
**[Ğ”Ğ•ĞĞ¬]** Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ [X] â€” [ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ]
- Ğ¥ÑƒĞº: [Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ´Ñ€Ğ°, Ğ—ĞĞ“Ğ›ĞĞ’ĞĞ«ĞœĞ˜]
- Ğ¢ĞµĞ¼Ğ°: [Ğ¾ Ñ‡Ñ‘Ğ¼ Ñ€Ğ¾Ğ»Ğ¸Ğº, 1 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ]
- CTA: [Ñ‡Ñ‚Ğ¾ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ğ¼ Ğ² ĞºĞ¾Ğ½Ñ†Ğµ]
- ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ: [Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¸ Ñ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ]

ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°:
- ĞĞµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹ Ğ¸Ğ· Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… 8 Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ğ¿Ğ¾Ğ´Ñ€ÑĞ´
- Ğ¡Ğ¾Ğ±Ğ»ÑĞ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¸: 50% Ğ¾Ñ…Ğ²Ğ°Ñ‚ / 25% Ğ¿Ñ€Ğ¾Ğ²Ğ¾ĞºĞ°Ñ†Ğ¸Ñ / 15% Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ğµ / 10% BTS
- Ğ¥ÑƒĞºĞ¸ Ğ¾ÑÑ‚Ñ€Ñ‹Ğµ Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ â€” Ğ½Ğµ Ñ€Ğ°Ğ·Ğ¼Ñ‹Ñ‚Ñ‹Ğµ
- Ğ¢ĞµĞ¼Ñ‹ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ: Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Shopify Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
""", max_tokens=1500)


def generate_scripts(plan: str) -> str:
    """ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ°."""
    print("âœï¸  ĞŸĞ¸ÑˆÑƒ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸...")

    return _ask_claude(f"""
Ğ¢Ñ‹ â€” ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ÑÑ‚ Instagram Reels @prodigylab.agency.

ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ Ğ‘Ğ Ğ•ĞĞ”Ğ:
{BRAND}

ĞŸĞ›ĞĞ ĞĞ ĞĞ•Ğ”Ğ•Ğ›Ğ®:
{plan}

ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ ĞŸĞĞ›ĞĞ«Ğ™ Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¸Ğ· 4 Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ².

Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾:
---
### [Ğ”Ğ•ĞĞ¬] â€” Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ [X]: [Ğ¢ĞµĞ¼Ğ°]

**Ğ¥Ğ£Ğš (Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½Ğµ):** [Ğ—ĞĞ“Ğ›ĞĞ’ĞĞ«ĞœĞ˜]

**Ğ¢ĞĞ™ĞœĞ˜ĞĞ“ Ğ˜ Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•:**
[00-02 ÑĞµĞº] [Ñ‡Ñ‚Ğ¾ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ÑˆÑŒ + Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑˆÑŒ/Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑˆÑŒ]
[02-10 ÑĞµĞº] ...
...

**Ğ¢Ğ•ĞšĞ¡Ğ¢ Ğ Ğ•Ğ§Ğ˜ (Ğ´Ğ¾ÑĞ»Ğ¾Ğ²Ğ½Ğ¾):**
[Ğ²ĞµÑÑŒ Ñ‚ĞµĞºÑÑ‚ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ½Ğ¾ÑĞ¸ÑˆÑŒ]

**CTA:** [Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°]
**ĞœĞ£Ğ—Ğ«ĞšĞ:** [Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€ Ñ‚Ñ€ĞµĞºĞ°]
**Ğ Ğ•ĞšĞ’Ğ˜Ğ—Ğ˜Ğ¢:** [Ñ‡Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ² ĞºĞ°Ğ´Ñ€Ğµ]
---

Ğ¡Ñ‚Ğ¸Ğ»ÑŒ: Ğ¶Ğ¸Ğ²Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ½Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº, Ğ½Ğµ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚. Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ñ‚ĞµĞ¼Ğ¿. ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ¸ĞºĞ°.
""", max_tokens=3500)


def generate_yearly_plan() -> str:
    """Ğ“Ğ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ğ»Ğ°Ğ½ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ."""
    print("ğŸ“† Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° 90 Ğ´Ğ½ĞµĞ¹...")

    return _ask_claude(f"""
Ğ¢Ñ‹ â€” ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³ @prodigylab.agency (Shopify-ÑÑ‚ÑƒĞ´Ğ¸Ñ, Ğ¡Ğ¨Ğ).

ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ Ğ‘Ğ Ğ•ĞĞ”Ğ:
{BRAND}

Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° 90 Ğ´Ğ½ĞµĞ¹ Ñ€Ğ°Ğ·Ğ±Ğ¸Ñ‚Ñ‹Ğ¹ Ğ¿Ğ¾ Ğ¼ĞµÑÑÑ†Ğ°Ğ¼.

Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑÑ†Ğ°:
**ĞœĞµÑÑÑ† N (Ğ½ĞµĞ´ĞµĞ»Ğ¸ X-Y)**
- Ğ¤Ğ¾ĞºÑƒÑ Ğ¼ĞµÑÑÑ†Ğ°: [Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°]
- ĞŸÑ€Ğ¾Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ²: [ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ´ ÑÑ‚Ğ°Ğ¿]
- ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹: [5-7 Ñ‚ĞµĞ¼ Ğ´Ğ»Ñ Ñ€Ğ¸Ğ»ÑĞ¾Ğ²]
- ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° ÑƒÑĞ¿ĞµÑ…Ğ°: [Ñ‡Ñ‚Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ñ€Ğ°ÑÑ‚Ğ¸]
- Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ°: [Ñ‡Ñ‚Ğ¾ Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ² ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ Ğ¼ĞµÑÑÑ†Ğµ]

ĞœĞµÑÑÑ† 1: Ğ Ğ¾ÑÑ‚ (Ñ‚ĞµÑÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ², Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶)
ĞœĞµÑÑÑ† 2: Ğ Ğ¾ÑÑ‚ + Ğ¿ĞµÑ€Ğ²Ğ°Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ
ĞœĞµÑÑÑ† 3: ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ + Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ TikTok

ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾, Ñ€ĞµĞ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾. Ğ‘ĞµĞ· Ğ²Ğ¾Ğ´Ñ‹.
""", max_tokens=2000)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TELEGRAM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def send_telegram(text: str):
    if not TG_TOKEN or not TG_CHAT_ID:
        print("âš ï¸  Telegram Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼")
        return

    print("ğŸ“± ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ Ğ² Telegram...")
    url = f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage"

    # Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° ĞºÑƒÑĞºĞ¸ Ğ´Ğ¾ 4000 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
    chunks = [text[i:i+4000] for i in range(0, len(text), 4000)]
    for i, chunk in enumerate(chunks[:5]):
        resp = requests.post(url, json={
            "chat_id": TG_CHAT_ID,
            "text": chunk,
            "parse_mode": "HTML"
        }, timeout=10)
        if resp.status_code == 200:
            print(f"  âœ… Ğ§Ğ°ÑÑ‚ÑŒ {i+1}/{len(chunks)} Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°")
        else:
            print(f"  âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Telegram: {resp.text}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OUTPUT / SAVE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def save_plan(analysis: str, plan: str, scripts: str) -> tuple[Path, str]:
    PLANS_DIR.mkdir(parents=True, exist_ok=True)
    date_str  = datetime.now().strftime("%Y-%m-%d")
    week_num  = datetime.now().isocalendar()[1]
    filepath  = PLANS_DIR / f"plan_{date_str}_week{week_num}.md"

    content = f"""# ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-Ğ¿Ğ»Ğ°Ğ½ @prodigylab.agency
**Ğ”Ğ°Ñ‚Ğ°:** {datetime.now().strftime('%d.%m.%Y %H:%M')} | ĞĞµĞ´ĞµĞ»Ñ {week_num}

---

## ĞĞ½Ğ°Ğ»Ğ¸Ğ·

{analysis}

---

## ĞŸĞ»Ğ°Ğ½ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ

{plan}

---

## Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸

{scripts}
"""
    with open(filepath, "w", encoding="utf-8") as f:
        f.write(content)

    print(f"ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾: {filepath}")
    return filepath, content


def show_stats(data: dict):
    reels = data.get("reels", [])
    if not reels:
        print("\nĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ Ñ€Ğ¸Ğ»ÑÑ‹ Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ğ¿Ñ†Ğ¸Ñ 1.")
        return

    print(f"\nğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ ({len(reels)} Ñ€Ğ¸Ğ»ÑĞ¾Ğ²)")

    fmt_stats: dict = {}
    for r in reels:
        fmt  = r.get("format", "?")
        views = r.get("metrics", {}).get("views", 0)
        if fmt not in fmt_stats:
            fmt_stats[fmt] = {"count": 0, "total_views": 0}
        fmt_stats[fmt]["count"] += 1
        fmt_stats[fmt]["total_views"] += views

    for fmt, s in sorted(fmt_stats.items()):
        avg = s["total_views"] // s["count"] if s["count"] else 0
        print(f"  Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ {fmt} ({FORMAT_NAMES.get(fmt,'?')}): "
              f"{s['count']} Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ², avg {avg} Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¾Ğ²")

    top = sorted(reels, key=lambda x: x.get("metrics", {}).get("views", 0), reverse=True)[:3]
    print("\nğŸ† Ğ¢ĞĞŸ-3:")
    for r in top:
        v = r.get("metrics", {}).get("views", 0)
        print(f"  {v:>5} views â€” [{r.get('format')}] Â«{r.get('hook','')[:55]}Â»")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UI HELPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def _header(title: str):
    print(f"\n{'â”€'*55}")
    print(f"  {title}")
    print(f"{'â”€'*55}")


def _banner():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        PRODIGY LAB â€” CONTENT AGENT  v1.0          â•‘
â•‘        ĞĞ½Ğ°Ğ»Ğ¸Ğ· Â· ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Â· Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•""")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def main():
    _banner()
    data = load_data()

    _header("ĞœĞ•ĞĞ®")
    print("  1 â€” Ğ’Ğ²ĞµÑÑ‚Ğ¸ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ + Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· + Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ")
    print("  2 â€” Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ")
    print("  3 â€” Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ½ Ğ±ĞµĞ· Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…")
    print("  4 â€” Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° 90 Ğ´Ğ½ĞµĞ¹ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº)")
    print("  q â€” Ğ’Ñ‹Ñ…Ğ¾Ğ´")

    choice = input("\n> ").strip().lower()

    if choice == "q":
        return

    if choice == "2":
        show_stats(data)
        return

    competitors = []

    if choice == "1":
        input_reels(data)
        data = load_data()          # Ğ¿ĞµÑ€ĞµÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
        competitors = input_competitors()

    if choice == "4":
        yearly = generate_yearly_plan()
        path = PLANS_DIR / "plan_90days.md"
        PLANS_DIR.mkdir(parents=True, exist_ok=True)
        with open(path, "w", encoding="utf-8") as f:
            f.write(f"# Plan 90 Ğ´Ğ½ĞµĞ¹ @prodigylab.agency\n\n{yearly}")
        print(f"ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾: {path}")
        send_telegram(f"ğŸ“† ĞŸĞ›ĞĞ ĞĞ 90 Ğ”ĞĞ•Ğ™\n\n{yearly[:3500]}")
        return

    # ĞĞ¿Ñ†Ğ¸Ğ¸ 1 Ğ¸ 3
    show_stats(data)

    analysis = analyze(data, competitors)
    plan     = generate_plan(analysis, data)
    scripts  = generate_scripts(plan)

    filepath, content = save_plan(analysis, plan, scripts)
    send_telegram(f"ğŸ“Š ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-Ğ¿Ğ»Ğ°Ğ½ @prodigylab.agency\n\n{content[:3500]}")

    print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ…  Ğ“ĞĞ¢ĞĞ’Ğ                                       â•‘
â•‘  ğŸ“  {str(filepath.name):<43}â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•""")


if __name__ == "__main__":
    main()
